# iHRM人力资源 - 处理token失效、退出登录、修改密码



# 一、退出登录

## 1.1 处理token失效

流程图如下所示

![image-20240122231649850](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240122231649850.png)

拦截器在如下所示的位置

![image-20240122232240424](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240122232240424.png)

```javascript
// 创建响应拦截器,并且两个参数都是回调函数
service.interceptors.response.use(
  // 请求成功时响应,此时的响应默认包裹了一层data，即response.data才是后台服务返回的内容
  (response) => {
    // 一次性解析出response.data中的三个属性
    const { data, message, success } = response.data
    if (success) {
      // 此时响应正常
      return data
    } else {
      Message({ type: 'error', message: message })
      return Promise.reject(new Error(message))
    }
  },
  // 请求失败时响应
  async(error) => {
    if (error.response.status === 401) {
      Message({ type: 'warning', message: 'token 超时了，请重新登录' })
      // token超时,调用action退出登录
      // dispatch返回的是一个promise，这里会等dispatch执行完再执行路由跳转
      await store.dispatch('user/logout')
      // 主动跳转到登录页
      router.push('/login')
      return Promise.reject(error)
    }
    // this.$message.warning 不能这么使用，因为此时的this不是组件实例对象
    Message({ type: 'error', message: error.message })
    // 默认支持promise的,下面语句相当于终止了当前promise的执行
    return Promise.reject(error)
  }
)
```

> async.....await：
>
> 我们store.dispatch('user/logout')中的dispatch其实是一个Promise，这里加一个“async.....await”是为了将用户的信息全部删除完成后再跳转到登录页router.push('/login')
>
> 加上“async.....await”后，就会强制等待把用户信息、token全部删除干净了再跳转到登录页

**拦截器中需要调用vuex内容**

![image-20240122235908561](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240122235908561.png)

```javascript
// Mutations类似java中的数据层，只对数据进行操作，不对业务操作（比如数据加减乘除）
const mutations = {
  // 从浏览器缓存删除token
  removeToken(state) {
    // 删除vuex的token
    state.token = null
    // 删除缓存中的token
    removeToken()
  },
  setUserInfo(state, userInfo) {
    state.userInfo = userInfo
  }
    ..........
}


/**
 * actions似java中的业务逻辑层，对逻辑操作，然后向mutations发送数据，在这个业务逻辑中也可以互相调用
 * actions可以做异步操作
 */
const actions = {
  // 退出登录的action
  logout(context) {
    // 删除用户token
    context.commit('removeToken')
    // 删除用户信息(设置用户信息为空对象)
    context.commit('setUserInfo', {})
  },
    ...................
}
```



## 1.2 调整下拉菜单

我们现在菜单的内容是英文的形式，现在调整成中文的形式

![image-20240309202917031](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309202917031.png)

其实就是页面这部分的内容：

![image-20240309222522752](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309222522752.png)

代码中的位置如下图所示：

![image-20240309222637040](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309222637040.png)

代码如下图所示：

```javascript
<template>
  <div class="navbar">
    <hamburger :is-active="sidebar.opened" class="hamburger-container" @toggleClick="toggleSideBar"/>

    <breadcrumb class="breadcrumb-container"/>

    <div class="right-menu">
      <el-dropdown class="avatar-container" trigger="click">
        <div class="avatar-wrapper">
          <!--用户头像，v-if判断用户头像是否存在-->
          <img v-if="avatar" :src="avatar" class="user-avatar">
          <!--如果用户头像不存在的时候执行下面的v-else,显示用户名的第一个字-->
          <!--当name时null或者undefined时name.charAt(0)会报错，但是当在name之后加上“?”后，如果name为null或者undefined，就不会执行charAt(0)，也不会报错了-->
          <!-- "name?" 可选操作符，表示验证name是否一定有值。 此语法需要vue2.7.0之后的版本-->
          <span v-else class="username">{{ name?.charAt(0) }}</span>
          <!--用户名称-->
          <span class="name">{{ name }}</span>
          <!--图标（设置图标，是一个齿轮的样式）-->
          <i class="el-icon-setting"/>
        </div>
        <el-dropdown-menu slot="dropdown" class="user-dropdown">
          <router-link to="/">
            <el-dropdown-item>
              <!--Home-->
              首页
            </el-dropdown-item>
          </router-link>
          <a target="_blank" href="https://github.com/PanJiaChen/vue-admin-template/">
            <el-dropdown-item>
              <!--Github-->
              项目地址
            </el-dropdown-item>
          </a>
          <a target="_blank" href="https://panjiachen.github.io/vue-element-admin-site/#/">
            <el-dropdown-item>
              <!--Docs-->
              修改密码
            </el-dropdown-item>
          </a>
          <!--divided 属性是在列的上面有个分割线，我们去掉-->
          <!--<el-dropdown-item divided @click.native="logout">-->
          <el-dropdown-item @click.native="logout">
            <span style="display:block;">
             <!--Log Out-->
              退出登录
            </span>
          </el-dropdown-item>
        </el-dropdown-menu>
      </el-dropdown>
    </div>
  </div>
</template>
```



## 1.3 退出登录

实现退出登录功能

![image-20240309223116817](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309223116817.png)

我们之前在处理token失效的时候写过退出的Action，我们直接调用就好了，调用完Action，直接将页面跳转到登录页面

```html
<el-dropdown-item @click.native="logout">
  <span style="display:block;">
   <!--Log Out-->
    退出登录
  </span>
</el-dropdown-item>
```

> native：事件的修饰符，此时是修饰@click点击事件，目的是注册组件的根元素的原生事件（也就是H5事件）
>
> 因为el-dropdown-item的标签并不是H5的标签，@click.native表示el-dropdown-item标签最终形成的H5的标签去注册H5标签的点击事件
>
> 如果不写“.native”表示注册的这个组件的自定义事件，而这个组件本身并没有click这个自定义事件，所以我们需要native触发click点击事件
>
> 对于某个标签有没有点击事件，el开头的标签我们开element-ui文档即可，通过下面的文档发现，el-dropdown-item并没有点击事件
>
> ![image-20240309223851432](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309223851432.png)



```javascript
  methods: {
    async logout() {
      // 清除用户信息
      await this.$store.dispatch('user/logout')
      // await表示等待上面的代码执行完毕后，执行下面的代码，跳转页面到登录界面
      this.$router.push('/login')
    }
  }
```

点击“退出登录”后，其实就跳转到了http://localhost:9528/#/login页面



# 二、修改密码

**实现下面的一个效果**

说明：超级管理员的密码不可修改，修改密码的时候要有校验功能

![image-20240309224505993](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309224505993.png)

**修改密码的整体流程**

![image-20240309225036204](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309225036204.png)

**依然是下面这个位置**

![image-20240309223116817](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309223116817.png)



## 2.1 弹出层dialog

> 解释修饰符sync
>
> 可以接收子组件传过来的事件和值
>
> 我们点击弹出层dialog的“×”号后，所以“showDialog”接收到了el-dialog传过来的false值
>
> 这些事情是在el-dialog源码中写的

```html
<template>
  <div>
    <!--放置dialog-->
    <!--title是dialog的标题; :visible.sync用来控制是否显示弹出层 sync作用是点击“×”号时能把弹出层关闭掉-->
    <el-dialog title="修改密码" :visible.sync="showDialog" width="450px">
      <!--放置dialog表单-->
    </el-dialog>
  </div>
</template>
```

```javascript
data() {
  return {
    // 控制弹层的显示和隐藏
    showDialog: false
  }
},
  methods: {
    updatePassword() {
      // 弹出层显示
      this.showDialog = true
    }
}
```



## 2.2 表单结构

如下图所示的结构

![image-20240309231143181](https://picture-typora-zhangjingqi.oss-cn-beijing.aliyuncs.com/image-20240309231143181.png)

```html
<!--放置dialog-->
<!--title是dialog的标题; :visible.sync用来控制是否显示弹出层 sync作用是点击“×”号时能把弹出层关闭掉-->
<el-dialog title="修改密码" :visible.sync="showDialog" width="450px">
  <!--放置dialog表单-->
  <!--设置完成label-width="120px"后，提示信息就和输入框在同一行了-->
  <el-form label-width="120px">
    <!--label属性其实就是此item的提示信息-->
    <el-form-item label="旧密码">
      <el-input show-password size="small"></el-input>
    </el-form-item>
    <!--show-password 属性表示输入的内容是密文-->
    <el-form-item label="新密码">
      <el-input show-password size="small"></el-input>
    </el-form-item>
    <el-form-item label="重复密码">
      <el-input show-password size="small"></el-input>
    </el-form-item>
    <!--按钮-->
    <el-form-item>
      <el-button size="mini" type="primary">确认修改</el-button>
      <el-button size="mini">取消修改</el-button>
    </el-form-item>
  </el-form>
</el-dialog>
```



## 2.3 表单校验



## 2.4 表单提交



# 三、路由

